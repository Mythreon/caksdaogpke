<!-- Spagettikoodi brought to you by me -->
<!DOCTYPE html>
<html lang="fi">
<head>
  <meta charset="UTF-8" />
  <title>Anna, kun selit√§n pelin.</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="cardgame.css">
</head>
<body>
<div id="loadingScreen" style="position: fixed; top:0; left:0; width:100vw; height:100vh; background:#0b630e; color:white; display:flex; justify-content:center; align-items:center; font-size:2rem; z-index:9999999;">
  Ladataan...
</div>
<header>
</header>

<h1>Anna, kun selit√§n pelin.</h1>
<div class="grid" id="cardGrid"></div>
<div id="scoreBox">Pisteet: 0</div>
<div id="totalScoreBox" alt="debuggingValueScoreBoard">Kaikkien pelien yhteispisteet: 0</div> 
<button id="resetBtn">Resetoi peli</button>

<div id="messageBox"></div>

<div id="highScores">
  <h3>Parhaat pisteet</h3>
  <ul id="scoreboardClassic"></ul>
</div>
<script src="changelogs.js"></script>
<script src="info.js"></script>
<script src="hs.js"></script>
<script src="asetukset.js"></script>
<script src="savegame.js"></script>
<script src="dev.ts"></script>
<script src="mm.js"></script>


<script>

  const suits = ["‚ô†", "‚ô•", "‚ô¶", "‚ô£"];
  const values = ["A", "2", "3", "4", "5", "6", "7", "8", "9", "10", "J", "Q", "K"];
  let deck = [];
  let gridCards = Array(3).fill(null).map(() => Array(3).fill(null));
  let score = 0;
  let misses = 0;
  let jokerCount = 0;
  let onlyJokers = false;
  let comboCount = 0;
  let evaluatedTriplets = [];

  const grid = document.getElementById("cardGrid");
  const scoreBox = document.getElementById("scoreBox");
  const messageBox = document.getElementById("messageBox");
  const resetBtn = document.getElementById("resetBtn");
  const scoreList = document.getElementById("scoreboardClassic");

  function createDeck() {
    deck = [];
    for (let suit of suits) {
      for (let value of values) {
        deck.push({ suit, value });
      }
    }
  }

  function shuffle(array) {
    for (let i = array.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [array[i], array[j]] = [array[j], array[i]];
    }
    return array;
  }

  function initGame() {
    jokerCount = parseInt(localStorage.getItem("jokerCount") || "0");
    score = 0;
    misses = 0;
    comboCount = 0;
    aceCount = 0;
    evaluatedTriplets = [];
    updateScoreDisplay();
    gridCards = Array(3).fill(null).map(() => Array(3).fill(null));
    grid.innerHTML = "";
    createDeck();
    const shuffledDeck = shuffle(deck).slice(0, 9);

    for (let i = 0; i < 3; i++) {
      for (let j = 0; j < 3; j++) {
        const card = shuffledDeck[i * 3 + j];
        const div = document.createElement("div");
        div.classList.add("card");
        div.textContent = "";

div.addEventListener("click", () => {
  if (!div.classList.contains("revealed")) {
    let isJoker = false;

    console.log(`Korttia klikattu: sijainti [${i}, ${j}]`);


if (onlyJokers) {
  isJoker = true;
} else {

const asetukset = (typeof window.getAsetukset === "function")
  ? window.getAsetukset()
  : { hardMode: false };

if (asetukset.hardMode) {
  if (Math.random() < 0.125) { 
    isJoker = true;
  }
} else {}
const jokerChances = [
  { condition: score < -1 || score > 1, chance: 0.0025 },
  { condition: score < -5 || score > 45, chance: 0.01 },
  { condition: score < -50 || score > 100, chance: 0.05 },
  { condition: score < -100 || score > 250, chance: 0.1 },
];

for (let { condition, chance } of jokerChances) {
  if (condition && Math.random() < chance) {
    isJoker = true;
    break;
  }
}
}

    div.classList.add("revealed");

    if (isJoker) {
      div.textContent = "üÉèJokeriüÉè";
      div.style.color = "purple";
      div.style.fontSize = "15px";
      score = 0;
      misses = 0;
      comboCount = 0;
      gridCards[i][j] = "Jokeri";
      jokerCount++;
      localStorage.setItem("jokerCount", jokerCount);
      console.log("üÉè Jokeri ilmestyi! Pisteet nollattu.");
      showMessage("Jokeri ilmestyi Pisteet nollattu!");
      div.classList.add("joker-anim");
      updateScoreDisplay();
    } else {
      const cardText = card.suit + card.value;
      div.textContent = cardText;
      if (card.suit === "‚ô•" || card.suit === "‚ô¶") div.classList.add("red");
      gridCards[i][j] = cardText;
      console.log(`Paljastettiin kortti: ${cardText} sijainnissa [${i}, ${j}]`);
      evaluateAllVisibleTriplets();
    }

          if (!isJoker && card.value === "A") {
        aceCount++;
        const acePoints = aceCount + 1;
        score += acePoints;
        showMessage(`Paljastit √§ss√§n! +${acePoints} pistett√§`);
        console.log(` √Ñss√§ +${acePoints} pistett√§`);
        updateScoreDisplay();
      }


    checkGameOver();
  }
});


        grid.appendChild(div);
      }
    }
  }

  function updateScoreDisplay() {
    scoreBox.textContent = `Pisteet: ${score}`;
  }

const messageQueue = [];
let messageShowing = false;

function showMessage(text) {
  const asetukset = (typeof window.getAsetukset === "function")
    ? window.getAsetukset()
    : { showMessages: true };

  if (!asetukset.showMessages) return;

  messageQueue.push(text);

  if (messageQueue.length > 5) {
    const combined = messageQueue.splice(0, messageQueue.length).join(" | ");
    messageQueue.push("üì¢ " + combined);
  }

  if (!messageShowing) {
    displayNextMessage();
  }
}


function displayNextMessage() {
  if (messageQueue.length === 0) {
    messageShowing = false;
    return;
  }

  messageShowing = true;
  const message = messageQueue.shift();

  messageBox.textContent = message;
  messageBox.classList.add("show");

  setTimeout(() => {
    messageBox.classList.remove("show");
    setTimeout(() => {
      displayNextMessage();
    }, 500); 
  }, 2500); 
}

function parseCard(cardText) {
  const suit = cardText[0];
  const value = cardText.slice(1);
  const orderMap = {
    "A": 1, "2": 2, "3": 3, "4": 4,
    "5": 5, "6": 6, "7": 7, "8": 8,
    "9": 9, "10": 10, "J": 11, "Q": 12, "K": 13
  };
  const color = (suit === "‚ô•" || suit === "‚ô¶") ? "red" : "black";
  return { suit, value, order: orderMap[value], color };
}


function evaluate(triplet) {
  const cards = triplet.map(parseCard);
  const suitsSet = new Set(cards.map(c => c.suit));
  const valuesSet = new Set(cards.map(c => c.value));
  const colorsSet = new Set(cards.map(c => c.color));
  const orders = cards.map(c => c.order).sort((a, b) => a - b);

  if (suitsSet.size === 1 && orders[1] - orders[0] === 1 && orders[2] - orders[1] === 1)
    return 20;
  if (orders[1] - orders[0] === 1 && orders[2] - orders[1] === 1)
    return 7;
  if (valuesSet.size === 1 && suitsSet.size > 1)
    return 5;
  if (valuesSet.size === 1)
    return 2;
  if (colorsSet.size === 1)
    return 1;

  if (colorsSet.size > 1)
    return -1;  

  return 0;
}

function getAllTripletsFromGrid(grid) {
  const triplets = [];

  for (let r = 0; r < 3; r++) {
    const row = grid[r];
    if (row.every(cell => cell)) {
      const coords = [[r, 0], [r, 1], [r, 2]];
      triplets.push({ cards: [row[0], row[1], row[2]], coords });
    }
  }

  for (let c = 0; c < 3; c++) {
    const col = [grid[0][c], grid[1][c], grid[2][c]];
    if (col.every(cell => cell)) {
      const coords = [[0, c], [1, c], [2, c]];
      triplets.push({ cards: col, coords });
    }
  }

  const diag1 = [grid[0][0], grid[1][1], grid[2][2]];
  if (diag1.every(cell => cell)) {
    triplets.push({
      cards: diag1,
      coords: [[0, 0], [1, 1], [2, 2]]
    });
  }

  const diag2 = [grid[0][2], grid[1][1], grid[2][0]];
  if (diag2.every(cell => cell)) {
    triplets.push({
      cards: diag2,
      coords: [[0, 2], [1, 1], [2, 0]]
    });
  }

  return triplets;
}

function evaluateAllVisibleTriplets() {
  const triplets = getAllTripletsFromGrid(gridCards);
  let positivePoints = 0;
  let negativePoints = 0;
  let newTripletsFound = false;

  for (let { cards, coords } of triplets) {
    const key = coords.map(([r, c]) => `${r}-${c}`).join("|");

    if (!evaluatedTriplets.includes(key)) {
      const allRevealed = coords.every(([r, c]) => {
        const cellIndex = r * 3 + c;
        const cell = grid.children[cellIndex];
        return cell && cell.classList.contains("revealed");
      });

      if (!allRevealed) {
        console.log(`Triplet ${key} ei viel√§ arvioitu ‚Äì ei kaikki paljastettu.`);
        continue;
      }

      evaluatedTriplets.push(key);
      newTripletsFound = true;

      const pts = evaluate(cards);

      console.log(`Arvioidaan triplet: [${coords.map(c => `[${c}]`).join(", ")}]`);
      console.log(`   ‚Üí Kortit: ${cards.join(", ")} ‚Üí Pisteet: ${pts}`);

      if (pts > 0) {
        positivePoints += pts;
      } else if (pts < 0) {
        negativePoints += pts;
      }
    } else {
      console.log(`TRIPLETTI ${key} on jo arvioitu, ohitetaan.`);
    }
  }

  if (positivePoints > 0) {
    comboCount++;
    const comboMultiplier = 1 + 0.5 * (comboCount - 1);
    const comboPoints = Math.floor(positivePoints * comboMultiplier);
    const total = comboPoints + negativePoints;
    score += total;

    let msg = `Combo x${comboCount}! +${comboPoints}p`;
    if (negativePoints < 0) {
      msg += `, mutta ${negativePoints}p hutia`;
    }

    showMessage(msg);
    console.log(`Combo x${comboCount}! ${comboPoints}p (raw: ${positivePoints}) + huti ${negativePoints}p ‚Üí yhteens√§ ${total}`);
    misses = 0;
} else if (newTripletsFound && negativePoints < 0) {
  score += negativePoints;
  showMessage(`Huti! ${negativePoints}p`);
  console.log(`Huti ‚Üí ${negativePoints} pistett√§`);
  misses += Math.abs(negativePoints); 
}

  updateScoreDisplay();
}



const totalScoreBox = document.getElementById("totalScoreBox");

function updateTotalScoreDisplay() {
  let allScores = JSON.parse(localStorage.getItem("allScores") || "[]");

  let rawTotal = allScores.reduce((sum, s) => sum + Number(s), 0); 
  let total = Math.round(Number(rawTotal.toFixed(5))); 

  if (total === 666) {
    total += 1; // You wouldn't want the devil to win, would you?
    allScores.push(1); 
    localStorage.setItem("allScores", JSON.stringify(allScores));
  }

  totalScoreBox.textContent = `Kaikkien pelien yhteispisteet: ${total}`;
}




function saveScore(score) {
  const scores = JSON.parse(localStorage.getItem("highScores") || "[]");
  scores.push(score);
  scores.sort((a, b) => b - a);
  if (scores.length > 5) scores.length = 5;
  localStorage.setItem("highScores", JSON.stringify(scores));

  const allScores = JSON.parse(localStorage.getItem("allScores") || "[]");
  allScores.push(score);
  localStorage.setItem("allScores", JSON.stringify(allScores));

  renderHighScores();
  updateTotalScoreDisplay();
}

updateTotalScoreDisplay();

function renderHighScores() {
  const scores = JSON.parse(localStorage.getItem("highScores") || "[]");
  scoreList.innerHTML = "";

  onlyJokers = scores.some(s => s > 500); 

  if (scores.length === 0) {
    scoreList.innerHTML = "<li>Ei tuloksia viel√§</li>";
  } else {
    for (let s of scores) {
      const li = document.createElement("li");
      li.textContent = s + " pistett√§";
      scoreList.appendChild(li);
    }
  }
}

if (onlyJokers) {
  console.log("üî• Jokerimoodi aktivoitu! üî•");
}
  if (onlyJokers) {
    showMessage("üî• Huijarimoodi aktivoitu! üî•");
  }

function checkGameOver() {
  const allRevealed = gridCards.flat().every(card => card !== null);
  if (allRevealed) {
    showMessage("Peli p√§√§ttyi! Pisteesi: " + score);
    saveScore(score);
      updateGameStats(score, aceCount, misses); 
  }
}

function updateGameStats(currentScore, currentAces, currentMisses) {
  const completed = parseInt(localStorage.getItem("gamesCompleted") || "0") + 1;
  localStorage.setItem("gamesCompleted", completed);

  const totalAces = parseInt(localStorage.getItem("totalAces") || "0") + currentAces;
  localStorage.setItem("totalAces", totalAces);

  const totalMisses = parseInt(localStorage.getItem("totalMisses") || "0") + currentMisses;
  localStorage.setItem("totalMisses", totalMisses);

  const allScores = JSON.parse(localStorage.getItem("allScores") || "[]");
  const average = allScores.length ? Math.round(allScores.reduce((a, b) => a + b, 0) / allScores.length) : 0;
  localStorage.setItem("averageScore", average);
}


resetBtn.addEventListener("click", () => {
  initGame();
});
resetBtn.addEventListener("touchstart", (e) => {
  e.preventDefault(); // Korjaa ongelman mobiililaitteilla. √ÑL√Ñ KOSKE!
  initGame();
});



  initGame();
  renderHighScores();


</script>
<!-- -->
<script>
</script>
</body>
</html>
