<!-- Spagettikoodi brought to you by me -->
<!DOCTYPE html>
<html lang="fi">
<head>
  <meta charset="UTF-8" />
  <title>Korttipeli 3x3</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
      header {
    position: fixed;
    top: 10px;
    left: 10px;
    background: rgba(0, 166, 3, 0.9);
    padding: 8px 12px;
    border-radius: 6px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    font-family: sans-serif;
    font-weight: bold;
    font-size: 16px;
    z-index: 10000;
  }

  header a {
    margin-right: 15px;
    text-decoration: none;
    color: #333;
    cursor: pointer;
    transition: color 0.2s ease;
  }

  header a:hover {
    color: #007bff;
  }


    body {
      font-family: sans-serif;
      text-align: center;
      padding: 30px;
      color: white;
background: #0b630e;
background: radial-gradient(circle,rgba(11, 99, 14, 1) 12%, rgba(0, 135, 25, 1) 54%, rgba(2, 125, 27, 1) 94%);
        }
        
        
        
.grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);  
  grid-gap: 10px;
  justify-content: center;
  margin-bottom: 20px;
  max-width: 25vw;
  min-width: 25vw;
  margin-left: auto;
  margin-right: auto;
}

.card {
  background: navy;
  color: transparent;
  font-size: 48px;       
  font-weight: bold;
  width: 100px;          
  height: 100px;        
  padding: 0;
  border-radius: 8px;
  box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
  cursor: pointer;
  transition: all 0.3s ease;
  text-align: center;
  display: flex;
  align-items: center;
  justify-content: center;
}


    .card.revealed {
      background: white;
      color: black;
    }
    .card.revealed.red {
      color: red;
    }
#messageBox {
  position: fixed;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(4, 108, 28, 0.9);
  color: #fff;
  padding: 15px 25px;
  border-radius: 10px;
  font-size: 18px;
  font-weight: bold;
  box-shadow: 0 2px 10px rgba(0,0,0,0.3);
  opacity: 0;
  z-index: 1000;
  transition: opacity 0.5s ease;
}

#messageBox.show {
  opacity: 1;
}


@keyframes fadeIn {
  from { opacity: 0; transform: translateX(-50%) translateY(10px); }
  to { opacity: 1; transform: translateX(-50%) translateY(0); }
}

    #scoreBox {
      margin-bottom: 15px;
      font-size: 22px;
      font-weight: bold;
      color: #fff176;
      text-shadow: 1px 1px 2px #000;

    }
    #highScores {
      position: fixed;
      top: 10px;
      right: 10px;
      margin-top: 25px;
      text-align: left;
      max-width: 200px;
      margin-left: auto;
      margin-right: auto;
      background: rgba(0, 92, 11, 0.2);
      padding: 10px;
      border-radius: 8px;
    }
    #highScores h3 {
      margin-top: 0;
    }
    button {
      margin-top: 10px;
      padding: 10px 20px;
      font-size: 18px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      background-color: #388e3c;
      color: white;
      box-shadow: 0 3px 6px rgba(0,0,0,0.3);
      transition: background-color 0.3s ease;
    }
    button:hover {
      background-color: #2e7d32;
    }
  </style>
</head>
<body>
<header>
</header>

<h1>Anna, kun selit√§n pelin.</h1>
<div class="grid" id="cardGrid"></div>
<div id="scoreBox">Pisteet: 0</div>
<button id="resetBtn">Resetoi peli</button>

<div id="messageBox"></div>

<div id="highScores">
  <h3>Parhaat pisteet</h3>
  <ul id="scoreboardClassic"></ul>
</div>
<script src="changelogs.js"></script>

<script>

  const suits = ["‚ô†", "‚ô•", "‚ô¶", "‚ô£"];
  const values = ["A", "2", "3", "4", "5", "6", "7", "8", "9", "10", "J", "Q", "K"];
  let deck = [];
  let gridCards = Array(3).fill(null).map(() => Array(3).fill(null));
  let score = 0;
  let misses = 0;
  let onlyJokers = false;
  let comboCount = 0;
  let evaluatedTriplets = [];

  const grid = document.getElementById("cardGrid");
  const scoreBox = document.getElementById("scoreBox");
  const messageBox = document.getElementById("messageBox");
  const resetBtn = document.getElementById("resetBtn");
  const scoreList = document.getElementById("scoreboardClassic");

  function createDeck() {
    deck = [];
    for (let suit of suits) {
      for (let value of values) {
        deck.push({ suit, value });
      }
    }
  }

  function shuffle(array) {
    for (let i = array.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [array[i], array[j]] = [array[j], array[i]];
    }
    return array;
  }

  function initGame() {
    score = 0;
    misses = 0;
    comboCount = 0;
    aceCount = 0;
    evaluatedTriplets = [];
    updateScoreDisplay();
    gridCards = Array(3).fill(null).map(() => Array(3).fill(null));
    grid.innerHTML = "";
    createDeck();
    const shuffledDeck = shuffle(deck).slice(0, 9);

    for (let i = 0; i < 3; i++) {
      for (let j = 0; j < 3; j++) {
        const card = shuffledDeck[i * 3 + j];
        const div = document.createElement("div");
        div.classList.add("card");
        div.textContent = "";

div.addEventListener("click", () => {
  if (!div.classList.contains("revealed")) {
    let isJoker = false;

    console.log(`Korttia klikattu: sijainti [${i}, ${j}]`);


if (onlyJokers) {
  isJoker = true;
} else {

  if (score < -1 || score > 1) {
   if (Math.random() < 0.0025) isJoker = true;
  }
  if (score < -5 || score > 45) {
    if (Math.random() < 0.01) isJoker = true;
  }
  if (score < -50 || score > 100) {
    if (Math.random() < 0.05) isJoker = true;
  }
  if (score < -100 || score > 250) {
    if (Math.random() < 0.1) isJoker = true;
  }
}


    div.classList.add("revealed");

    if (isJoker) {
      div.textContent = "üÉèJokeriüÉè";
      div.style.color = "purple";
      score = 0;
      misses = 0;
      comboCount = 0;
      gridCards[i][j] = "Jokeri";
      console.log("üÉè Jokeri ilmestyi! Pisteet nollattu.");
      showMessage("Jokeri ilmestyi Pisteet nollattu!");
      updateScoreDisplay();
    } else {
      const cardText = card.suit + card.value;
      div.textContent = cardText;
      if (card.suit === "‚ô•" || card.suit === "‚ô¶") div.classList.add("red");
      gridCards[i][j] = cardText;
      console.log(`Paljastettiin kortti: ${cardText} sijainnissa [${i}, ${j}]`);
      evaluateAllVisibleTriplets();
    }

          if (card.value === "A") {
        aceCount++;
        const acePoints = aceCount + 1;
        score += acePoints;
        showMessage(`Paljastit √§ss√§n! +${acePoints} pistett√§`);
        console.log(` √Ñss√§ +${acePoints} pistett√§`);
        updateScoreDisplay();
      }


    checkGameOver();
  }
});


        grid.appendChild(div);
      }
    }
  }

  function updateScoreDisplay() {
    scoreBox.textContent = `Pisteet: ${score}`;
  }

const messageQueue = [];
let messageShowing = false;

function showMessage(text) {
  messageQueue.push(text);
  if (!messageShowing) {
    displayNextMessage();
  }
}

function displayNextMessage() {
  if (messageQueue.length === 0) {
    messageShowing = false;
    return;
  }

  messageShowing = true;
  const message = messageQueue.shift();

  messageBox.textContent = message;
  messageBox.classList.add("show");

  setTimeout(() => {
    messageBox.classList.remove("show");
    setTimeout(() => {
      displayNextMessage();
    }, 500); 
  }, 2500); 
}


function parseCard(cardText) {
  const suit = cardText[0];
  const value = cardText.slice(1);
  const orderMap = {
    "A": 1, "2": 2, "3": 3, "4": 4,
    "5": 5, "6": 6, "7": 7, "8": 8,
    "9": 9, "10": 10, "J": 11, "Q": 12, "K": 13
  };
  const color = (suit === "‚ô•" || suit === "‚ô¶") ? "red" : "black";
  return { suit, value, order: orderMap[value], color };
}


function evaluate(triplet) {
  const cards = triplet.map(parseCard);
  const suitsSet = new Set(cards.map(c => c.suit));
  const valuesSet = new Set(cards.map(c => c.value));
  const colorsSet = new Set(cards.map(c => c.color));
  const orders = cards.map(c => c.order).sort((a, b) => a - b);

  if (suitsSet.size === 1 && orders[1] - orders[0] === 1 && orders[2] - orders[1] === 1)
    return 20;
  if (orders[1] - orders[0] === 1 && orders[2] - orders[1] === 1)
    return 7;
  if (valuesSet.size === 1 && suitsSet.size > 1)
    return 5;
  if (valuesSet.size === 1)
    return 2;
  if (colorsSet.size === 1)
    return 1;

  if (colorsSet.size > 1)
    return -1;  

  return 0;
}



function getAllTripletsFromGrid(grid) {
  const triplets = [];

  for (let r = 0; r < 3; r++) {
    const row = grid[r];
    if (row.every(cell => cell)) {
      const coords = [[r, 0], [r, 1], [r, 2]];
      triplets.push({ cards: [row[0], row[1], row[2]], coords });
    }
  }

  for (let c = 0; c < 3; c++) {
    const col = [grid[0][c], grid[1][c], grid[2][c]];
    if (col.every(cell => cell)) {
      const coords = [[0, c], [1, c], [2, c]];
      triplets.push({ cards: col, coords });
    }
  }

  const diag1 = [grid[0][0], grid[1][1], grid[2][2]];
  if (diag1.every(cell => cell)) {
    triplets.push({
      cards: diag1,
      coords: [[0, 0], [1, 1], [2, 2]]
    });
  }

  const diag2 = [grid[0][2], grid[1][1], grid[2][0]];
  if (diag2.every(cell => cell)) {
    triplets.push({
      cards: diag2,
      coords: [[0, 2], [1, 1], [2, 0]]
    });
  }

  return triplets;
}

function evaluateAllVisibleTriplets() {
  const triplets = getAllTripletsFromGrid(gridCards);
  let positivePoints = 0;
  let negativePoints = 0;
  let newTripletsFound = false;

  for (let { cards, coords } of triplets) {
    const key = coords.map(([r, c]) => `${r}-${c}`).join("|");

    if (!evaluatedTriplets.includes(key)) {
      const allRevealed = coords.every(([r, c]) => {
        const cellIndex = r * 3 + c;
        const cell = grid.children[cellIndex];
        return cell && cell.classList.contains("revealed");
      });

      if (!allRevealed) {
        console.log(`Triplet ${key} ei viel√§ arvioitu ‚Äì ei kaikki paljastettu.`);
        continue;
      }

      evaluatedTriplets.push(key);
      newTripletsFound = true;

      const pts = evaluate(cards);

      console.log(`Arvioidaan triplet: [${coords.map(c => `[${c}]`).join(", ")}]`);
      console.log(`   ‚Üí Kortit: ${cards.join(", ")} ‚Üí Pisteet: ${pts}`);

      if (pts > 0) {
        positivePoints += pts;
      } else if (pts < 0) {
        negativePoints += pts;
      }
    } else {
      console.log(`TRIPLETTI ${key} on jo arvioitu, ohitetaan.`);
    }
  }

  if (positivePoints > 0) {
    comboCount++;
    const comboMultiplier = 1 + 0.5 * (comboCount - 1);
    const comboPoints = Math.floor(positivePoints * comboMultiplier);
    const total = comboPoints + negativePoints;
    score += total;

    let msg = `Combo x${comboCount}! +${comboPoints}p`;
    if (negativePoints < 0) {
      msg += `, mutta ${negativePoints}p hutia`;
    }

    showMessage(msg);
    console.log(`Combo x${comboCount}! ${comboPoints}p (raw: ${positivePoints}) + huti ${negativePoints}p ‚Üí yhteens√§ ${total}`);
    misses = 0;
} else if (newTripletsFound && negativePoints < 0) {
  score += negativePoints;
  showMessage(`Huti! ${negativePoints}p`);
  console.log(`Huti ‚Üí ${negativePoints} pistett√§`);
  misses += Math.abs(negativePoints); 
}

  updateScoreDisplay();
}




  function saveScore(score) {
    const scores = JSON.parse(localStorage.getItem("highScores") || "[]");
    scores.push(score);
    scores.sort((a, b) => b - a);
    if (scores.length > 5) scores.length = 5;
    localStorage.setItem("highScores", JSON.stringify(scores));
    renderHighScores();
  }

function renderHighScores() {
  const scores = JSON.parse(localStorage.getItem("highScores") || "[]");
  scoreList.innerHTML = "";

  onlyJokers = scores.some(s => s > 500); 

  if (scores.length === 0) {
    scoreList.innerHTML = "<li>Ei tuloksia viel√§</li>";
  } else {
    for (let s of scores) {
      const li = document.createElement("li");
      li.textContent = s + " pistett√§";
      scoreList.appendChild(li);
    }
  }
}

if (onlyJokers) {
  console.log("üî• Jokerimoodi aktivoitu! üî•");
}
  if (onlyJokers) {
    showMessage("üî• Huijarimoodi aktivoitu! üî•");
  }

  function checkGameOver() {
    const allRevealed = gridCards.flat().every(card => card !== null);
    if (allRevealed) {
      showMessage("Peli p√§√§ttyi! Pisteesi: " + score);
      if (score > 0) saveScore(score);
    }
  }

resetBtn.addEventListener("click", () => {
  initGame();
});


  initGame();
  renderHighScores();
</script>



</body>
</html>
